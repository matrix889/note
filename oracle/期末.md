[TOC]

### Problem
1. SCN号
2. p390联机备份时系统崩溃 alter database和alter tablespace
3. 联机备份， DML操作，重做日志文件
4. alter system or alter database?
5. 还原表空间，只读表空间，临时表空间（各个表空间的作用）
6. 用户权限
7. scn号
8. 优化数据库系统内存？ java池 and ？
9. PCTFREE？
10. 闪回进程，快照进程，活动会话进程
11. 静态参数修改，动态参数 alter system set ....=... scope = spfile
12. 数据库实例
13. sga和pga的构成
14. oracle的结构

### 名词
1. AWR		自动工作负载库
2. ADDM		自我诊断引擎

### 进程
1. MMAN 内存管理，如果设定了SGA自动管理，MMAN用来协调SGA内各组件的大小设置和大小调整。
2. MMON 是可管理行监视器（Manageability Monitor）,主要用于AWR，ADDM，会从SGA中将统计结果写到系统表中
3. MMNL 活动会话进程（Manageability monitor)
4. RVWR 闪回进程（recovery writer)

### 常用数据字典

1. v$controlfile 查看控制文件信息
2. v$logfile 查看日志文件信息
3. dba_data_files 找到所有的数据文件，以及与表空间的对应关系。
4. v\$datafile 和 v\$tablespace 找到所有的临时文件，以及与临时表空间的对应关系。
5. show parameter pfile 找到正文参数文件或二进制文件。
6. v$archive_dest 归档文件的相关信息
7. v$backup 查看表空间的备份状态
8. v$log_history 重做日志文件切换相关信息
9. v$recover_file 查看文件回复状态
10. user_recyclebin 查看回收站所使用的磁盘空间信息
11. flashback_transaction_query   闪回信息
12. v$active_session_history	  

### 常用参数
1. show parameter bin		//闪回。。。

### 常用的操作

1. truncate table tryTable; 	//将表清空，无法回滚
2. alter system switch logfile; //切换重做日志文件组
3. select * from cat 		//查看该用户下的所有表和视图
4. show recyclebin		//查看回收站中的表
5. purge table table_name 	//清空回收站
6. flashback table table_name to before drop;	//用闪回的方式将删除的表恢复
7. drop table table_name purge;			//直接删除一个表而不放入回收站

### 进程

1. LGWR: 重做日志写进程，负责将重做日志缓冲区的信息写到重做日志文件中（读内存写外存）.
2. ARCn: 将切换后的重做日志文件复制到归档日志文件。（读外存写外存）.

### 第十六章

####  冷备份
冷备份也叫脱机或关机备份，即在数据库关闭的状态下进行物理备份（如操作系统的拷贝）。

#### 非归档模式

1. 查看归档状态

```
archive log list
```

#### 备份常用术语

1. 数据库的全备份：备份数据库的所有的数据文件和控制文件，这也是最常用的备份方法。在全备份时，数据库可以处于关闭或打开状态，但在非归档模式下
数据库必须处于关闭状态。

2. 控制文件的备份：可以通过SQL命令来备份。

3. 表空间的备份：备份组成某一表空间的所有文件。在非归档模式下，只能单独地备份只读表空间或正常脱机（offline normal）的表空间。

4. 数据文件的备份：备份单个的数据文件。在非归档模式下，只能单独地备份只读数据文件或正常脱机（offline normal）的数据文件。

5. 部分备份：表空间的备份和数据文件的备份也叫部分备份或不完全备份，因为它们通常是在数据库打开的状态下做的备份，需要使用归档日志文件或重做日志文件来
恢复（！！！）


#### 冷备份具体步骤（p339)

1. 利用Oracle的数据字典或命令找到所有需要备份的文件。
2. 正常关闭数据库（使用shutdown immediate|transactional|normal)。
3. 将所有文件复制到备份硬盘或磁带上。
4. 重新启动数据库（startup）。

#### 冷恢复（脱机恢复）

数据库运行在非归档模式下，只能进行脱机恢复。

#### 脱机恢复的具体步骤

1. 关闭数据库。
2. 将所有的备份数据文件和备份控制文件复制到数据库中原来的位置。
3. 也可以将所有的备份重做日志文件,参数文件和口令文件复制到数据库中原来的位置。
4. 重新启动数据库。
5. 恢复成功之后，数据库即恢复到上一次备份的状态。

#### 脱机备份的优点和缺点

##### 优点

1. 脱机备份的概念非常简单，就是在正常关闭数据库之后复制所有的文件。
2. 因为数据库处在正常关闭状态，因此所做的备份也是最可靠的。
3. 操作非常容易，如果将所有的备份命令写入脚本，只要运行脚本即可。
4. 所需的人工操作很少，如果可以写成自动脚本，则可以不需要人工操作。

##### 缺点

1. 备份时必须关闭数据库，这堆那些每天24小时每周7填运营的数据库是完全不可行的，如银行或电信数据系统。

2. 必须备份所有的数据文件和控制文件，对大型和超大型数据库来说，其数据量可以达到几百GB以上，如此大的数据量几乎是无法备份的。对于一些数据库系统绝大多数
数据都是静止的而只有少数的数据时经常变化的（如几十MB），现在为了要备份这几十MB变量的数据，必须备份整个数据库。


#### 脱机恢复的有点和缺点

##### 优点

1. 数据恢复的概念也非常简单，在正常关闭数据库之后，将所有的备份文件复制回数据库中。
2. 操作非常容易，数据库处在正常关闭状态，因此所做的恢复也是最可靠的。

##### 缺点

1. 在恢复时必须关闭数据库，这对那些每天24小时每周7填运营的数据库也是完全不可以接受的，如银行和电信数据库系统。
2. 数据库回到上一次备份的时间点。从上一次备份到系统崩溃这段时间内的所有提交数据将全部丢失。
3. 必须将所有的数据文件和控制文件的备份复制会数据库中。

#### toRead
1. p341 实例
2. p355 alter database rename ....


### 第十七章

#### 数据库的归档模式

1. 在非归档模式下，数据库只能保证恢复到上一次备份的时间点。
2. 要是归档的操作自动化，首先必须将数据库设置为归档模式，其次要启动归档后台进程（ARCn），还要有足够的硬盘空间以存储
持续产生的归档日志文件。
3. 归档模式下归档后台进程没有启动，并且没有发过手动归档命令，那么当重做日志切换了一圈之后LGWR必须等待重做日志文件中的提交数据被
复制到归档日志文件后才能些重做日志文件，只有这样Oracle系统才能保证所有的提交数据得到完好的保存，也才能保证数据库的完全恢复。然后归档后台进程
并没有启动，因此重做日志文件中的提交数据永远也不会被复制到归档日志文件，所以LGWR陷入了永久的等待，实际上此时数据库已经挂起。（!!!）

#### 将数据库设置为归档模式

##### 步骤

1. 以sysdba身份登录Oracle数据库。
2. 使用 archive log list 命令查看数据库与归档相关的信息。
3. 正常关闭数据库，如使用shutdown immediate命令。
4. 以加载方式启动数据库（startup mount）。
5. 用 Alter database 命令将数据库设置为归档模式（alter database archivelog）。
6. 打开数据库（alter database open）。
7. 再用 archive log list 命令验证当前数据库与归档相关的信息。
8. 做数据库的全备份。

#### 手动归档

1. 在Oracle 10之前的版本中，将数据库设置为归档模式后，Oracle系统并不自动启动归档后台进程（ARCn），这也叫手动归档模式。如果归档后台进程启动了，就由归档进程将
添满的重做日志文件复制到归档日志文件，这也叫自动归档模式。
2. 手工完成从重做日志文件到归档日志文件的复制工作的SQL*Plus命令如下：
```
alter system archive log current;
```

#### 自动归档

1. alter system archive log start;(在Oracle 10g 之前，当数据库重启之后，归档后台进程并不自动地启动，必须使用相同的命令来启动。）
2.  修改参数文件中的log_archive_start参数为true
+  show parameter log_arhive_start 检查 log_archive_start 参数的值是否为true。
+  使用 alter system set log_archive_start = true scope = spfile;因为该参数为静态参数，必须使用scope  = spfile选项,即修改二进制参数文件中的log_archive_start参数。（!!!）
+  shutdown immediate
+  startup
+  show parameter log_archive_start。

#### 归档进程和归档文件目录的设置

1. 可以启动多个归档后台进程以避免由于ARCn 进程跟不上LGWR 而造成的数据库系统效率下降（LGWR必须等待重做日志文件中的提交数据被复制到归档日志文件后才能些重做日志文件，只有这样
Oracle 系统才能保证所有的提交数据得到完好的保存。）命令：

```
alter system set log_archive_max_processes = 4;
```
该参数是动态参数，可以通过

```
show parameter log_archive_processes
```

来查看该参数的当前值。

2. 设置归档日志文件写道的物理硬盘和目录。
```
alter system set log_archive_dest_ = "LOCATION=F:\... optional";
```

>location 参数设置了文件的存放路径，optional/mandatory表示该目录录下的归档日志文件是可选的/强制的，即在该目录下的归档日志文件即使没有写成功，所对应的重做日志文件也可以重用。

查看当前归档日志文件位置。
```
show parameter log_archive_dest_
```

3. alter system set log_archie_desc_state_1 = defer; //临时维护状态，当归档日志的状态被设置为defer时，Oracle不会对这个路径进行归档操作。


### 第十八章

#### 联机备份
只要数据库运行在归档模式下，Oracle 不但可以进行练级备份，而且还可以进行表空间一级或数据文件一级的联机备份

##### 联机备份的优点与缺点

1. 优点：
* 在备份期间数据库可以正常运行
* 既可以备份表空间也可以备份数据文件，备份数据量减小
* 在备份期间用户仍然可以正常使用数据库。

2. 缺点：
* 因为数据库运行在归档模式，所以系统的开销增大，管理和维护成本增加。
* 对DBA的技术要求高(。。。）

#### 步骤

1. 使用数据字典dba_data_files 找到需要备份的数据文件及其对应的表空间。
2. 使用数据字典v$backup 确认数据文件的备份状态。
3. 用alter tablespace "表空间名" begin backup; 将需要备份的表空间设置为备份状态。
4. 使用操作系统复制命令将该表空间所对应的数据文件复制到要备份到的位置。
5. 用alter tablespace "。。。" end backup; 将已经备份成功的表空间设置为结束备份状态
6. 将当前的重做日志文件的信息写道归档日志文件中去。
7. 再使用数据字典v$backup确认数据文件的备份状态。
8. 验证操作系统文件是否生成。

#### 其他

1. 当一个表空间或数据文件处在备份状态时，对其进行DML操作，数据写入到重做日志文件中去。
2. 进行联机备份时，需要注意以下几点：
* 重做日志缓冲区和重做日志文件都应该适当加大。
* 每次只备份一个表空间。
* 在DML操作最少的时间段进行联机备份。

### 第十九章

#### Restore 与 Recover 的区别：

Restore将数据带回到过去（备份的时间点）+Recover回复从备份到数据文件崩溃这段时间内所有提交的数据=>数据库的完全回复（所有提交的数据都恢复）.

### 第二十章

数据的移动可以使用Oracle提供的数据的到处（exp)和导入（imp)工具（应用程序）来完成数据的移动。Oracle 10g 引入了数据泵(Data Pump)，这是一个导入和导出工具的改进版。

#### 导入和导出工具能够完成的操作

* 重组表。
* 在不同的数据库用户之间移动数据。
* 在不同的计算机之间，不同的数据库之间和不同的Oracle服务器之间移动数据。
* 在不同的数据库之间移动数据表空间。
* 将表的定义存入二进制的操作系统文件以防止用户操作造成数据的丢失。
* 为某一数据库对象或整个数据库建立历史档案，因为数据库的结构和数据都是随着商业需求不停地发生变化的。
* 逻辑备份，其中包括数据库对象，表空间和整个数据库的逻辑备份。

#### 逻辑备份的缺点
逻辑备份是不能对数据库进行完全恢复的，即数据的丢失是在所难免的。从到处开始到导入位置，这段时间之内的数据将全部对视。所以，逻辑备份不能作为备份和恢复策略的基石，它们必须要有物理备份以保证全恢复，逻辑备份只能作为辅助的手段。

#### 逻辑备份的优势
* 与任何一种物理备份和恢复方式相比，它都十分简单。
* 它可以防止用户错误，如用户如果以外地删除或截断了某个表。在这种情况下，如果没有逻辑备份想要恢复此表就必须进行不完全回复
* 在某个表上进行了很多错误的DML操作并已经提交。
* 在某个表逻辑崩溃的情况下，如果没有逻辑备份而又想恢复此表，则也要进行不完全恢复。

#### toRead
from p442 数据泵

### 第二十一章
利用Oracle 10g引入的闪回（Flashback)技术在绝大多数情况下可以完全避免令人生畏的不完全恢复，而且速度更快，更安全，更可靠也更简单。

#### 闪回技术：
1. 当一个表被删除时，它并不是真的被删除了而只是被放到了回收站（recylebin)里了。
2. Oralce 并不保证所有被删除的表都能闪回成功，因为当用户在某个表空间上创建一个新表（或需要磁盘空间）,Oracle将使用回收站的磁盘空间。因此在创建表空间时最好流出足够的表空间以方便日后进行恢复工作。

#### 闪回错误的DML操作
1. show parameter undo_retention	//查看闪回操作时限
2. alter system set undo_retention = 7200 
3. select versions_xid, name, age
from scott.emp
versions between scn minvalue and maxvalue	//查询操作信息

#### toRead
from p490

### 第二十二章

#### 优化工作的具体步骤和工作顺序
1. 优化数据库系统的设计
2. 优化数据库系统的应用（程序）
3. *优化数据库系统内存*
4. *优化数据库系统的输入/输出（I/O)*
5. 优化数据库系统的资源竞争
6. 优化数据库所基于的操作系统

#### SQL语句优化
p531

#### SGA 
1. SGA_MAX_SIZE	分配给系统全局区（SGA)的最大内存
2. lock_sga 	整个SGA是否被锁在物理内存中
3. pre_page_sga 在实例系统启动时，整个SGA是否会被读入物理内存中

##### sga动态参数（自动调整）
1. 以下为4个静态系统参数（不能动态修改）
* lock_sga
* pre_page_sga
* sga_max_size
* sga_target		//主管sga的自动管理

2. 如何让Oracle自动调整SGA各个部分的大小。
* 将sga_target参数设置为非零
* 将statistics_level参数的值设置为TYPICAL或ALL

#### toread
p556
 
